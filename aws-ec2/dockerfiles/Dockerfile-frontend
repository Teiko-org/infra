FROM node:21-bookworm AS build
WORKDIR /app

# Instala primeiro somente manifestos para cache eficaz
COPY ./frontend/carambolo-doces/package*.json ./

# Instala dependências (inclui opcionais para rollup) com cache
RUN npm ci --include=optional || npm install --include=optional

# Copia o código depois para aproveitar cache de deps
COPY ./frontend/carambolo-doces ./

RUN npm run build

# Runtime leve (Node para servir via Express)
FROM node:21-bookworm-slim
WORKDIR /app
ENV NODE_ENV=production
RUN npm init -y && npm i express http-proxy-middleware
COPY infra/aws-ec2/dockerfiles/server.js /app/server.js
COPY --from=build /app/dist /app/dist
EXPOSE 8080
CMD ["node", "server.js"]


